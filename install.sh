#!/bin/bash
# Seth Art (sethsec@gmail.com, @sethsec)

WORKING_DIRECTORY="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ "$EUID" -ne 0 ]; then
  echo "This script must be run as root or with sudo" 1>&2
  exit 1
fi

gather-info()
{
  echo
  echo "This install script will perform the following actions:"
  echo "  1) Download and install Adobe Flex (A 230mb download)"
  echo "  2) Provide you with a library of exploitation templates"
  echo "  3) Create a self-signed SSL certificate"
  echo "  4) "
  echo "  5) Give you some guidance on how to compile your ActionScript3 into a SWF"
  echo
  echo "Unrelated to compiling SWF files, this script will also copy the" 
  echo "http-crossdomain.nse NMAP script into /usr/share/nmap/scripts/ "
  echo "so that you can use it. I'll remove this once the nse gets added"
  echo "to NMAP."
  echo 
  echo
  echo "Before we get started, here is your opportunity to deviate from "
  echo "the default flex locations. "
  echo 
  echo "To accept the default setting, just hit enter:"

  read -p "  * Flex Install Location [/opt/flex]: " FLEX_LOCATION
  if [ -z "$FLEX_LOCATION" ]; then
    FLEX_LOCATION=/opt/flex
  fi
  echo 
  echo 
}


main()
{
  if [ ! -d $FLEX_LOCATION ]; then
    mkdir $FLEX_LOCATION 
  fi
  cd $FLEX_LOCATION/ 
  if [ ! -f flex_sdk_4.6.zip ]; then
    download-flex
  else
    FLEX_CHECKSUM=`sha512sum $FLEX_LOCATION/flex_sdk_4.6.zip | awk '{print $1}'`
    if [ "$FLEX_CHECKSUM" != "e553553c2a536b31400c444b84a697e337f33eded344ffaaa8b8978a237e5a77f358f850073003b4bfd519e5947a5a1ca1c87324336b922d4ccda7cd94889737" ]; then
      download-flex
    fi    
  fi
  echo "Creating self-signed SSL cert..."
  if [ ! -f $WORKING_DIRECTORY/server.pem ]; then
    openssl req -new -x509 -keyout $WORKING_DIRECTORY/server.pem -out $WORKING_DIRECTORY/server.pem -days 365 -nodes 
  fi

  echo "Copying http-crossdomain.nse to /usr/share/nmap/scripts/..."
  cp $WORKING_DIRECTORY/http-crossdomain.nse /usr/share/nmap/scripts/
}

download-flex()
{
  echo "Downloading Flex..."
  wget http://download.macromedia.com/pub/flex/sdk/flex_sdk_4.6.zip
  FLEX_CHECKSUM=`sha512sum $FLEX_LOCATION/flex_sdk_4.6.zip | awk '{print $1}'`
  if [ "$FLEX_CHECKSUM" == "e553553c2a536b31400c444b84a697e337f33eded344ffaaa8b8978a237e5a77f358f850073003b4bfd519e5947a5a1ca1c87324336b922d4ccda7cd94889737" ]; then
    echo "Extracting Flex to $FLEX_LOCATION"
    unzip -o flex_sdk_4.6.zip 
    chmod -R a+rx $FLEX_LOCATION/
    echo 'export PATH=$FLEX_LOCATION/bin:$PATH' >> ~/.bashrc
    chmod 755 bin/mxmlc
  else
    read -p "Invalid checksum for flex_sdk_4.6.zip download.  Are you sure you want to continue? (y/n)" CK_SM_CONT
    if [ "$CK_SM_CONT" == "y" ]; then
      unzip flex_sdk_4.6.zip 
      chmod -R a+rx $FLEX_LOCATION/
      echo 'export PATH=$FLEX_LOCATION/bin:$PATH' >> ~/.bashrc
      chmod 755 bin/mxmlc
    else
      exit 
    fi
  fi


}

print-next-steps()
{
  echo
  echo
  echo
  echo "*****************"
  echo "*  Next Steps   *"
  echo "*****************"
  echo ""
  echo "1) Choose a template from $WORKING_DIRECTORY/actionscript-templates"
  echo ""
  echo "2) Edit the file:"
  echo ""
  echo "   a) Specify the target URL"
  echo "        Something like: http://vulnerable.com/account/settings"
  echo "   b) Specify the :"
  echo "        Something like: https://attacker/, or https://192.168.0.100, or https://www.attacker.com/"
  echo ""
  echo "2) Compile the ActionScript file and move the SWF to the web root:"
  echo ""
  echo "   a) $FLEX_LOCATION/bin/mxmlc $WORKING_DIRECTORY/actionscript-templates/XDomainXploit.as --output $WORKING_DIRECTORY/webroot/exploit.swf"
  echo ""
  echo "3) Edit $WORKING_DIRECTORY/webroot/index.html (which launches the SWF) and make sure it is pointing to the right SWF file"
  echo "4) Get your victim to navigate to http://<your-hostname-or-ip>/<path>/index.html"
  echo "5) Collect your bounty at $WORKING_DIRECTORY/bounty/"
  echo ""
  echo "* Additional templates have been provided, and are located in the following directory:"
  echo "* $AS_LOCATION"
  echo ""     
  echo "Good luck!"
  echo ""
}

gather-info
main
print-next-steps
